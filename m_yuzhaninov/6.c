#include <stdio.h>
// Для взаимодействия с файлом
#include <unistd.h>
// Для открытия файла
#include <fcntl.h>
#include <stdlib.h>
#include <sys/select.h>

int main()
{
    // Переменная для записи файлового дискриптора
    int fd;
    // Текст содержащий начало каждой строки
    long text[1000];  
    // Переменная для хранения позиции
    long pos = 0; 
    // Переменная для записи длинны строки
    int len = 0;
    char symbol;
    // Массив содержащий длины строк
    int lengths[1000];
    // Количество строк
    int count = 0;

    // Открывает файл для чтения
    fd = open("data.txt", O_RDONLY);

    // Первая строка начинается с нулевого отступа
    text[0] = 0;

    // Читаем по одному байту из файла, чтобы найти символ переноса строки
    while (read(fd, &symbol, 1) > 0)
    {
        pos++;
        len++;
        if (symbol == '\n')
        {
            // Записываем длинну текущей строки
            lengths[count] = len;
            count++;
            // Записываем начало следующей строки
            text[count] = pos;
            len = 0;
        }
    }

    // Если последняя строка не заканчивается символом переноса строки
    if (len > 0)
    {
        // Записываем длинну
        lengths[count] = len;
        count++;
    }

    while (1)
    {
        int n;
        printf("Введите номер строки: ");
        // Принудительно выводим буфер stdout
        fflush(stdout);

        // Создаем множество файловых дескрипторов
        fd_set rfds;
        // Структура для паузы 
        struct timeval tv;
        // Очищаем множество
        FD_ZERO(&rfds);
        // Добавляем дескриптор stdin, чтобы за ним можно было следить
        FD_SET(0, &rfds);
        // Ставим количество секунд для паузы
        tv.tv_sec = 5;
        // Количество микросекунд
        tv.tv_usec = 0;

        // Ждем событие на дескрипторах
        // Первый аргумент это максимальный дескриптор + 1
        // Второй это множество дескрипторов для чтения 
        // Следующие два отвечают за запись и ошибки
        // Последний это пауза
        int retval = select(1, &rfds, NULL, NULL, &tv);

        // Если вернулся 0, то пользователь ничего не ввел
        if (retval == 0)
        {
            printf("\nВремя вышло! Содержимое файла:\n\n");
            // Переменная для записи символов
            char buffer[1000];
            // Смещаем указатель на начало
            lseek(fd, 0, SEEK_SET);
            int r;
            // Пока мы можем что то прочитать - читаем
            while ((r = read(fd, buffer, sizeof(buffer))) > 0)
            {
                // Выводим символы в консоль
                write(1, buffer, r);
            }

            break;
        }
        // Иначе 
        else
        {
            // Ввод остается в буфере stdin и scanf читает оттуда номер строки
            scanf("%d", &n);

            // Если 0, то завершаем программу
            if (n == 0)
                break;

            // Проверка на корректность
            if (n < 1 || n > count)
            {
                printf("Нет такой строки.\n");
                continue;
            }

            // Смещаем курсор до начала нужной строки
            // SEEK_SET говорит что отсчет идет от начала файла
            lseek(fd, text[n - 1], SEEK_SET);

            // Выделяем память под строку и читаем ее
            char *line = malloc(lengths[n - 1] + 1);
            read(fd, line, lengths[n - 1]);
            // Убираем символ переноса строки
            if (line[lengths[n - 1] - 1] == '\n')
            {
                line[lengths[n - 1] - 1] = '\0';
            }
            else 
            {
                line[lengths[n - 1]] = '\0';
            }

            printf("Строка %d: %s\n", n, line);
            free(line);
        }
    }

    close(fd);
    return 0;
}
